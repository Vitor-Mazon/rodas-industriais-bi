USE rodas_dw;

DROP TABLE IF EXISTS fat_item_venda;
DROP TABLE IF EXISTS fat_venda;
DROP TABLE IF EXISTS dim_produto;
DROP TABLE IF EXISTS dim_cliente;

---------------------------------------------------------------------------------------------------------------
--- Tabelas Dimensionais
---------------------------------------------------------------------------------------------------------------

CREATE TABLE dim_cliente (
    id_cliente INT PRIMARY KEY,
    nome      VARCHAR(100),
    cidade    VARCHAR(100),
    estado    CHAR(2),
    segmento  VARCHAR(100)
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE TABLE dim_produto (
    id_roda   INT PRIMARY KEY,
    tipo_roda VARCHAR(50),
    modelo    VARCHAR(50),
    diametro  INT,
    largura   INT,
    marca     VARCHAR(50),
    categoria VARCHAR(100)
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

INSERT INTO dim_cliente (id_cliente, nome, cidade, estado, segmento) VALUES
  (1,'LogPlast','Araras','SP','Logística'),
  (2,'Embrac','Rio Claro','SP','Industria'),
  (3,'Julifork','Rio de Janeiro','RJ','Revenda'),
  (4,'Oliveira','Juiz de Fora','MG','Logística'),
  (5,'BrunoPeças','Campinas','SP','Industria'),
  (6,'ForkParts','São Paulo','SP','Revenda'),
  (7,'Guevara','São Paulo','SP','Industria'),
  (8,'Milano','Campinas','SP','Industria'),
  (9,'Mendonça','Araras','SP','Logística'),
  (10,'Verano','Araras','SP','Revenda');

INSERT INTO dim_produto (id_roda, tipo_roda, modelo, diametro, largura, marca, categoria) VALUES
  (100,'Tração','EGV',230,70,'Still','Transpaleteira'),
  (101,'Tração','ETV',353,135,'Toyota','Transpaleteira'),
  (102,'Carga','ETV',80,120,'Toyota','Transpaleteira'),
  (103,'Apoio','ETV',100,50,'Toyota','Transpaleteira'),
  (104,'Tração','FMX',343,135,'Still','Empilhadeira'),
  (105,'Apoio','JHC',100,80,'Linde','Paleteira'),
  (106,'Carga','ECX',150,50,'Heli','Empilhadeira'),
  (107,'Tração','EP',343,135,'Heli','Empilhadeira'),
  (108,'Carga','JJ2',80,50,'Junghenreich','Paleteira'),
  (109,'Carga','ECX',80,75,'Heli','Empilhadeira'),
  (110,'Apoio','EGV',75,40,'Still','Empilhadeira');

---------------------------------------------------------------------------------------------------------------
--- Tabelas de Fato
---------------------------------------------------------------------------------------------------------------

CREATE TABLE fat_venda (
    id_venda INT PRIMARY KEY,
    id_cliente INT,
    data_venda DATE,
    canal_venda VARCHAR(50),
    status VARCHAR(20),
    FOREIGN KEY (id_cliente) REFERENCES dim_cliente(id_cliente)
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE TABLE fat_item_venda (
    id_item INT PRIMARY KEY,
    id_venda INT,
    id_roda INT,
    qtde INT,
    valor_unit DECIMAL(10,2),
    FOREIGN KEY (id_venda) REFERENCES fat_venda(id_venda),
    FOREIGN KEY (id_roda) REFERENCES dim_produto(id_roda)
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

INSERT INTO fat_venda (id_venda, id_cliente, data_venda, canal_venda, status) VALUES
(1,1,'2025-01-03','WhatsApp','FECHADA'),
(2,3,'2025-01-04','E-mail','FECHADA'),
(3,7,'2025-01-06','Telefone','ABERTA'),
(4,2,'2025-01-09','WhatsApp','FECHADA'),
(5,9,'2025-01-11','Indicação','FECHADA'),
(6,5,'2025-01-13','E-mail','FECHADA'),
(7,6,'2025-01-15','WhatsApp','FECHADA'),
(8,10,'2025-01-18','Visita Técnica','FECHADA'),
(9,4,'2025-01-20','Indicação','FECHADA'),
(10,8,'2025-01-22','E-mail','ABERTA'),
(11,1,'2025-02-01','WhatsApp','FECHADA'),
(12,3,'2025-02-03','Visita Técnica','FECHADA'),
(13,7,'2025-02-04','WhatsApp','FECHADA'),
(14,2,'2025-02-07','E-mail','FECHADA'),
(15,9,'2025-02-08','Telefone','FECHADA'),
(16,5,'2025-02-11','E-mail','ABERTA'),
(17,6,'2025-02-13','WhatsApp','FECHADA'),
(18,10,'2025-02-15','Indicação','FECHADA'),
(19,4,'2025-02-18','WhatsApp','FECHADA'),
(20,8,'2025-02-20','E-mail','CANCELADA'),
(21,1,'2025-03-02','WhatsApp','FECHADA'),
(22,3,'2025-03-04','E-mail','FECHADA'),
(23,7,'2025-03-05','Telefone','FECHADA'),
(24,2,'2025-03-08','WhatsApp','FECHADA'),
(25,9,'2025-03-10','Indicação','FECHADA'),
(26,5,'2025-03-13','E-mail','FECHADA'),
(27,6,'2025-03-14','WhatsApp','ABERTA'),
(28,10,'2025-03-16','Visita Técnica','FECHADA'),
(29,4,'2025-03-19','Indicação','FECHADA'),
(30,8,'2025-03-21','Telefone','FECHADA'),
(31,1,'2025-04-02','WhatsApp','FECHADA'),
(32,3,'2025-04-03','E-mail','ABERTA'),
(33,7,'2025-04-05','Indicação','FECHADA'),
(34,2,'2025-04-08','WhatsApp','FECHADA'),
(35,9,'2025-04-10','E-mail','FECHADA'),
(36,5,'2025-04-12','Indicação','FECHADA'),
(37,6,'2025-04-14','WhatsApp','FECHADA'),
(38,10,'2025-04-17','Visita Técnica','FECHADA'),
(39,4,'2025-04-19','E-mail','FECHADA'),
(40,8,'2025-04-22','Telefone','FECHADA'),
(41,1,'2025-05-03','WhatsApp','FECHADA'),
(42,3,'2025-05-04','Telefone','FECHADA'),
(43,7,'2025-05-06','Indicação','FECHADA'),
(44,2,'2025-05-08','WhatsApp','FECHADA'),
(45,9,'2025-05-11','E-mail','CANCELADA'),
(46,5,'2025-05-13','Visita Técnica','FECHADA'),
(47,6,'2025-05-15','WhatsApp','FECHADA'),
(48,10,'2025-05-18','E-mail','ABERTA'),
(49,4,'2025-05-21','Indicação','FECHADA'),
(50,8,'2025-05-27','WhatsApp','FECHADA'),
(51,1,'2025-06-02','WhatsApp','FECHADA'),
(52,3,'2025-06-04','E-mail','FECHADA'),
(53,7,'2025-06-06','Telefone','FECHADA'),
(54,2,'2025-06-08','Indicação','ABERTA'),
(55,9,'2025-06-10','WhatsApp','FECHADA'),
(56,5,'2025-06-12','E-mail','FECHADA'),
(57,6,'2025-06-14','Visita Técnica','FECHADA'),
(58,10,'2025-06-16','Telefone','CANCELADA'),
(59,4,'2025-06-18','Indicação','FECHADA'),
(60,8,'2025-06-20','WhatsApp','FECHADA'),
(61,1,'2025-07-02','WhatsApp','FECHADA'),
(62,3,'2025-07-04','E-mail','FECHADA'),
(63,7,'2025-07-06','Telefone','ABERTA'),
(64,2,'2025-07-08','WhatsApp','FECHADA'),
(65,9,'2025-07-10','Indicação','FECHADA'),
(66,5,'2025-07-12','E-mail','FECHADA'),
(67,6,'2025-07-14','WhatsApp','FECHADA'),
(68,10,'2025-07-17','Visita Técnica','FECHADA'),
(69,4,'2025-07-19','Telefone','FECHADA'),
(70,8,'2025-07-22','E-mail','CANCELADA'),
(71,1,'2025-08-02','WhatsApp','FECHADA'),
(72,3,'2025-08-04','Telefone','FECHADA'),
(73,7,'2025-08-06','Indicação','FECHADA'),
(74,2,'2025-08-08','WhatsApp','FECHADA'),
(75,9,'2025-08-10','E-mail','FECHADA'),
(76,5,'2025-08-12','Indicação','ABERTA'),
(77,6,'2025-08-14','WhatsApp','FECHADA'),
(78,10,'2025-08-17','Visita Técnica','FECHADA'),
(79,4,'2025-08-19','Telefone','FECHADA'),
(80,8,'2025-08-22','E-mail','FECHADA'),
(81,1,'2025-09-02','WhatsApp','ABERTA'),
(82,3,'2025-09-04','E-mail','FECHADA'),
(83,7,'2025-09-06','Telefone','FECHADA'),
(84,2,'2025-09-08','Indicação','FECHADA'),
(85,9,'2025-09-10','WhatsApp','FECHADA'),
(86,5,'2025-09-12','E-mail','CANCELADA'),
(87,6,'2025-09-14','WhatsApp','FECHADA'),
(88,10,'2025-09-17','Visita Técnica','FECHADA'),
(89,4,'2025-09-19','Telefone','FECHADA'),
(90,8,'2025-09-22','Indicação','FECHADA'),
(91,1,'2025-10-02','WhatsApp','FECHADA'),
(92,3,'2025-10-04','E-mail','FECHADA'),
(93,7,'2025-10-06','Telefone','FECHADA'),
(94,2,'2025-10-08','WhatsApp','FECHADA'),
(95,9,'2025-10-10','Indicação','FECHADA'),
(96,5,'2025-10-12','E-mail','FECHADA'),
(97,6,'2025-10-14','WhatsApp','CANCELADA'),
(98,10,'2025-10-17','Visita Técnica','FECHADA'),
(99,4,'2025-10-19','Telefone','FECHADA'),
(100,8,'2025-10-22','E-mail','FECHADA');

INSERT INTO fat_item_venda (id_item, id_venda, id_roda, qtde, valor_unit) VALUES
(1,1,100,2,380),
(2,1,104,1,420),
(3,2,107,1,160),
(4,2,102,1,780),
(5,3,105,2,260),
(6,4,100,1,400),
(7,4,103,2,140),
(8,5,101,1,190),
(9,5,107,2,150),
(10,6,102,1,820),
(11,7,100,2,390),
(12,7,104,1,450),
(13,8,105,1,270),
(14,9,101,2,180),
(15,10,107,1,155),
(16,11,100,1,410),
(17,11,102,1,800),
(18,12,103,2,145),
(19,12,101,1,200),
(20,13,105,1,275),
(21,14,100,2,395),
(22,14,104,1,430),
(23,15,102,1,780),
(24,15,101,1,185),
(25,16,107,2,150),
(26,17,105,1,260),
(27,17,103,2,140),
(28,18,102,1,850),
(29,19,101,1,195),
(30,19,104,1,420),
(31,20,100,2,380),
(32,20,107,1,165),
(33,21,102,1,820),
(34,22,105,2,270),
(35,23,103,1,150),
(36,24,104,1,450),
(37,24,100,1,390),
(38,25,101,1,200),
(39,25,107,1,155),
(40,26,102,1,780),
(41,27,103,2,135),
(42,27,105,1,260),
(43,28,100,1,410),
(44,28,104,1,435),
(45,29,101,2,185),
(46,30,107,1,160),
(47,30,102,1,810),
(48,31,100,1,420),
(49,31,105,1,270),
(50,32,103,2,140),
(51,33,101,1,200),
(52,33,107,2,155),
(53,34,102,1,820),
(54,34,104,1,430),
(55,35,100,1,395),
(56,36,105,1,265),
(57,36,103,2,140),
(58,37,101,1,190),
(59,37,107,1,150),
(60,38,102,1,850),
(61,39,104,1,440),
(62,39,100,1,400),
(63,40,103,2,145),
(64,40,105,1,275),
(65,41,102,1,780),
(66,42,101,2,185),
(67,42,107,1,160),
(68,43,100,2,410),
(69,43,104,1,435),
(70,44,103,2,150),
(71,45,105,1,260),
(72,45,101,1,190),
(73,46,102,1,890),
(74,46,107,1,165),
(75,47,100,1,395),
(76,47,104,1,445),
(77,48,103,2,140),
(78,48,105,1,270),
(79,49,102,1,830),
(80,49,101,1,200),
(81,50,107,1,155),
(82,50,100,1,420),
(83,51,100,2,400),
(84,51,104,1,430),
(85,52,102,1,810),
(86,52,107,1,165),
(87,53,103,2,150),
(88,54,105,1,270),
(89,55,101,1,195),
(90,55,107,2,155),
(91,56,102,1,820),
(92,57,104,1,445),
(93,58,100,2,390),
(94,59,101,1,200),
(95,60,105,1,280),
(96,61,102,1,830),
(97,61,107,1,160),
(98,62,100,1,410),
(99,62,104,1,435),
(100,63,103,2,145),
(101,64,105,1,275),
(102,65,101,1,205),
(103,65,107,1,160),
(104,66,102,1,800),
(105,67,104,1,440),
(106,68,100,2,420),
(107,69,103,1,150),
(108,70,105,1,270),
(109,71,102,1,840),
(110,71,107,1,165),
(111,72,100,1,415),
(112,72,104,1,440),
(113,73,101,1,200),
(114,74,105,1,275),
(115,75,102,1,830),
(116,76,103,2,140),
(117,77,100,1,395),
(118,78,104,1,450),
(119,79,101,1,210),
(120,80,107,1,160),
(121,81,105,1,280),
(122,82,102,1,820),
(123,83,100,2,410),
(124,84,104,1,435),
(125,85,101,1,205),
(126,86,103,2,145),
(127,87,102,1,840),
(128,88,107,1,165),
(129,89,100,1,420),
(130,90,104,1,440),
(131,91,102,1,830),
(132,92,100,1,415),
(133,92,104,1,445),
(134,93,101,1,210),
(135,94,105,1,275),
(136,95,102,1,820),
(137,96,100,1,400),
(138,97,103,2,150),
(139,98,104,1,450),
(140,99,101,1,205),
(141,100,102,1,830),
(142,100,107,1,165);

-----------------------------------------------------------------
-- Ajustes para criar clientes com compras em apenas 1 mês
-- Guevara (7) -> tudo em março
UPDATE fat_venda
SET data_venda = '2025-03-10'
WHERE id_cliente = 7 AND status = 'FECHADA';

-- Milano (8) -> tudo em agosto
UPDATE fat_venda
SET data_venda = '2025-08-12'
WHERE id_cliente = 8 AND status = 'FECHADA';

-- Vizualização dos clientes com maior fidelidade (mais meses com compras)
SELECT
  c.nome,
  COUNT(DISTINCT DATE_FORMAT(v.data_venda, '%Y-%m')) AS meses_com_compra,
  COUNT(*) AS qtd_vendas_fechadas
FROM fat_venda v
JOIN dim_cliente c 
  ON c.id_cliente = v.id_cliente
WHERE v.status = 'FECHADA'
GROUP BY 
  c.nome
ORDER BY 
  meses_com_compra, 
  qtd_vendas_fechadas DESC;
